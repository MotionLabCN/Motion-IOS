#!/bin/sh

#æˆ‘çš„ç»ˆç«¯è«è®¤ç¿»å¢™ å…ˆå…³æ‰
# proxy_off;
script_dir=$(cd $(dirname $0);pwd)
projectDirectory=$(dirname $script_dir)
echo "è„šæœ¬ç›®å½•=${script_dir}"
echo "å·¥ç¨‹ç›®å½•=${projectDirectory}"

# ä¿®æ”¹scheme 
scheme="Motion"
# BundleIdentifier="com.sup.tiquantool.Motion"
BundleIdentifier="com.yce.nurse111"


#["app-store", "ad-hoc", "development", "developer-id", "package", "enterprise"]
method="development"
# method="ad-hoc"
# method="app-store"

version_number=""
new_build_number=""
ipaPath=""
ipaName=${scheme}
# ğŸ’ŠğŸ‘ŒğŸ’ğŸ‚ğŸ‘ğŸ¿ğŸŒ¹â¬†ï¸ãŠ™ï¸ğŸ±ğŸ©ğŸ‚ğŸ²âœˆï¸ğŸ‘€ğŸš€ğŸ”¥ğŸ®ğŸ’•ğŸ†ğŸ ğŸ’¯ ğŸŒ¹
#ç”Ÿæˆbuildå·
function generateBuildNumber(){
    # usr/libexec/PlistBuddy ç”¨æ¥è·å–info.plist ä¿¡æ¯
    # agvtool ç”¨æ¥å…¨å±€è®¾ç½®buildå· ä¹Ÿå¯ä»¥ç”¨ usr/libexec/PlistBuddy  agvtoolå¿…éœ€åœ¨.xcodeprojç›®å½•ä¸‹
    # cd ~/Documents/GitHub/jzt_supplier_ios/JZT_SUPPLIER 
    cd ${projectDirectory}
    version_number=$(agvtool what-marketing-version -terse1)
    old_build_number=$(agvtool what-version -terse)

    # info_plist_file=./${scheme}/Other/Info.plist
    # version_number=$(/usr/libexec/PlistBuddy -c "Print CFBundleShortVersionString" ${info_plist_file})
    # old_build_number=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" ${info_plist_file})
    
    echo "ä¿®æ”¹ ${version_number} ç¯ å¢ƒ è‡³ ${method} ğŸ‘€ ğŸ‘€ ğŸ‘€ ğŸ‘€ ğŸ‘€ ğŸ’Š ğŸ’Š ğŸ’Š ğŸ’Š ğŸ’Š ğŸ’Š" 
    # if [ ${method} = "app-store" ]
    # then
    # #appstore 
    #     # new_build_number=${version_number//./0}
    #     # cat ./fastlane/environmentDev.m > ./JZT_SUPPLIER/JZTProjectConfig.m 
    #     new_build_number=`date +%Y%m%d%H%M%S`
    # else
    # #ad-hoc  æµ‹è¯•ç‰ˆæœ¬ 
    #     # cat ./fastlane/environmentPro.m > ./JZT_SUPPLIER/JZTProjectConfig.m 
    #     new_build_number=`date +%Y%m%d%H%M%S`
    # fi
    if [ ${method} = "development" ]
    then
        new_build_number=`date +%m%d%H%M`
    else
        new_build_number=`date +%y%m%d%H%M`
    fi

    echo "ä¿®æ”¹buildå· ãŠ™ï¸ ãŠ™ï¸ ãŠ™ï¸ ãŠ™ï¸ ãŠ™ï¸ ãŠ™ï¸ ãŠ™ï¸ ãŠ™ï¸ âœˆï¸ âœˆï¸ âœˆï¸ âœˆï¸ âœˆï¸ âœˆï¸ âœˆï¸"
    echo æ—§çš„buildå·æ˜¯ ${old_build_number} æ–°çš„buildå·æ˜¯ ${new_build_number}
    if [ $old_build_number = $new_build_number ] 
    then
        echo ä¸¤ä¸ªbuildå·æ˜¯ä¸€æ ·çš„ ä¸ä¿®æ”¹
    else
        agvtool new-version -all ${new_build_number} 
    fi
}



function changeDisplayName() {
    info_plist_file=${projectDirectory}/${scheme}/Info.plist
    echo "infoplist = ${info_plist_file}"
    # ä¿®æ”¹åº”ç”¨å
    /usr/libexec/PlistBuddy -c "Set :CFBundleName $appName" ${info_plist_file}
}

#æäº¤ä¿®æ”¹åˆ°git
function pushToGit(){
    #need? git config --global credential.helper store 
    # git add .
    # git commit -m "æ‰“æµ‹è¯•åŒ…" #æµ‹è¯•
    # git commit -m "æ‰“æ­£å¼åŒ…" #æ­£å¼
    # git push
    git add --all; git commit -m "æ‰“åŒ…æäº¤ã€‚ã€‚ã€‚"; git pull; git push;
}

#æ‰“åŒ…
function archive(){
    # which xxx  æŸ¥çœ‹å‘½ä»¤å®‰è£…è·¯å¾„
    cd ${projectDirectory}
    ipaPath=${projectDirectory}/Targets/${version_number}/${new_build_number}
    echo "ipaPath = " + ${ipaPath} + "å¼€å§‹æ‰“åŒ…ğŸ ğŸ ğŸ ğŸ ğŸ ğŸ ğŸ ğŸ ğŸš€ ğŸš€ ğŸš€ ğŸš€ ğŸš€ ğŸš€"

    # fastlane build \
    # ipaPath:"${ipaPath}" \
    # ipaName:"${ipaName}" \
    # method:"${method}"

    # ä¸éœ€è¦ç”¨ Fastfile
    #app-store, ad-hoc, enterprise, development
    fastlane run build_ios_app scheme:${scheme}  export_method:${method} \
      export_xcargs:"-allowProvisioningUpdates" \
      output_directory:${ipaPath} output_name:${ipaName} \
      buildlog_path:"./Targets" silent:"true" clean:false
    
    echo "æ‰“åŒ…å®Œæˆ ğŸ‰ ğŸ‰ ğŸ‰"
}


#ä¸Šä¼ 
function uploadDsym() {
    echo "ğŸš€ä¸ŠğŸš€ä¼ ğŸš€dsym -> https://bugly.qq.com/v2/crash-reporting/preferences/dsyms/ffb92630a6?pid=2"
    # cdåˆ° buildç›®å½• ä¸€èˆ¬è¿™ä¸ªç›®å½•ä¼šæœ‰ appsup.ipa å’Œ appsup.app.DSYM.zip æ–‡ä»¶
    cd ${ipaPath}

    curl -k "https://api.bugly.qq.com/openapi/file/upload/symbol?app_key=f19da498-e39f-40d2-bdb8-6de3c062ef95&app_id=f55b0e3405" \
     --form "api_version=1" \
     --form "app_id=f55b0e3405" \
     --form "app_key=f19da498-e39f-40d2-bdb8-6de3c062ef95" \
     --form "symbolType=2"  \
     --form "bundleId=${BundleIdentifier}" \
     --form "productVersion=${version_number}" \
     --form "fileName=${ipaName}.app.dSYM.zip" \
     --form "file=@${ipaName}.app.dSYM.zip" \
     --verbose
}


function uploadIpa(){
    echo "å¼€å§‹ä¸Šä¼ ipaâ¬†ï¸ â¬†ï¸ â¬†ï¸ â¬†ï¸ â¬†ï¸ â¬†ï¸ â¬†ï¸ â¬†ï¸ â¬†ï¸ â¬†ï¸ â¬†ï¸"
    if [ ${method} = "development" ]
    then
        # uploadAdhocPgy
        uploadSelfServer
    elif [ ${method} = "ad-hoc" ]
    then
        # uploadAdhocPgy
        uploadSelfServer
    elif [ ${method} = "app-store" ]
    then
        uploadAppstore
    else
        echo "åŒºåˆ†ä¸äº†method"
    fi
}


function uploadAdhocPgy(){
    echo "adhoc ç‰ˆæœ¬ ä¸Šä¼ è’²å…¬è‹± â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸"
    cd ${ipaPath}
    
    curl -F "file=@${ipaName}.ipa" \
     -F "uKey=4160b56a739d06a6e84a68ecf69c0a3b" \
     -F "_api_key=8db1d53efc98afbed7b9566698df95f1" \
      https://upload.pgyer.com/apiv1/app/upload
    
    # deleteIpa
}


function uploadSelfServer() {
    echo "adhoc ç‰ˆæœ¬ ä¸Šä¼ åˆ° è‡ªå·±æœåŠ¡å™¨http://dev.oms.luguanjia.com/appManage/list.html â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸"
    cd ${ipaPath}

    curl -F "file=@${ipaName}.ipa" \
     -F "id=22" \
     -F "clientType=ios" \
     -F "title=é¹¿ç®¡å®¶åŒ»ç”Ÿç«¯" \
     -F "appCode=user" \
     -F "version=0.1.2" \
     -F "versionMust=0.1.1" \
     -F "content=æ›´æ–°" \
     http://dev.bsi.luguanjia.com/server/appUpdate/save
}


function uploadAppstore()
{
    echo "appstore ç‰ˆæœ¬ ä¸Šä¼ appstoreâ¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸"
    cd ${ipaPath}

    alias altool='/Applications/Xcode.app/Contents/Applications/Application\ Loader.app/Contents/Frameworks/ITunesSoftwareService.framework/Versions/A/Support/altool'
    xcrun altool -v -f ${scheme}.ipa -u 350442340@qq.com -p bvpy-kzmx-pfmu-qlzv -t ios
    altool --upload-app -f ${scheme}.ipa -t ios -u 350442340@qq.com -p bvpy-kzmx-pfmu-qlzv
}

#åˆ é™¤ipa
function deleteIpa()
{
    # cd ${projectDirectory}
    # rm -rf ipa
    echo "æ²¡æœ‰åˆ "
}

function start()
{
    starttime=`date +'%Y-%m-%d %H:%M:%S'`

    generateBuildNumber
    # pushToGit
    archive
    if [ ${method} = "app-store" ]
    then
        echo "è‡ªå·±ä¸Šä¼ appstoreå§...."
    else
        echo "ä¸Šä¼ è’²å…¬è‹±å’Œè‡ªå·±æœåŠ¡å™¨...."
        # cd ${script_dir}
        uploadAdhocPgy
    fi
    
    # uploadDsym

    endtime=`date +'%Y-%m-%d %H:%M:%S'`

    echo "å¼€å§‹æ—¶é—´ : " ${starttime}
    echo "ç»“æŸæ—¶é—´ : " ${endtime}
    echo "build = " ${new_build_number}
    echo "æ‚¨æœ‰ä¸€ä¸ªæ–°çš„Appç‰ˆæœ¬ï¼Œè¯·åŠæ—¶æ›´æ–°ğŸ‘Œ ğŸ”¥ ğŸ‘Œ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ‘Œ ğŸ”¥ ğŸ‘Œ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥"
}

start














